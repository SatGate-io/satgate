# =============================================================================
# SatGate - Full Stack Docker Compose
# =============================================================================
#
# This compose file runs the complete SatGate stack:
#   - Backend API (Node.js) - Your protected endpoints
#   - Aperture (L402 Proxy) - Lightning payment gateway
#   - Docs Server - Playground & documentation
#
# Prerequisites:
#   - Docker & Docker Compose
#   - Lightning Node Connect (LNC) credentials from Terminal Web
#
# Quick Start:
#   1. Copy env.example to .env and fill in your LNC credentials
#   2. Run: docker-compose -f docker-compose.full.yml up -d
#   3. Open: http://localhost:8080/docs/
#
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Backend API Server (Your Protected Endpoints)
  # ---------------------------------------------------------------------------
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: satgate-backend
    restart: unless-stopped
    expose:
      - "8083"
    environment:
      - NODE_ENV=production
      - BACKEND_PORT=8083
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8083/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - satgate-internal
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ---------------------------------------------------------------------------
  # Aperture - L402 Lightning Payment Gateway
  # ---------------------------------------------------------------------------
  aperture:
    build:
      context: .
      dockerfile: Dockerfile.aperture
    container_name: satgate-aperture
    restart: unless-stopped
    ports:
      - "${APERTURE_PORT:-8081}:8081"
    volumes:
      - ./aperture.docker.yaml:/home/aperture/.aperture/aperture.yaml:ro
      - aperture-data:/home/aperture/.aperture/data
    command: >
      --configfile=/home/aperture/.aperture/aperture.yaml
      --authenticator.network=${LNC_NETWORK:-mainnet}
      --authenticator.passphrase=${LNC_PASSPHRASE}
      --authenticator.mailboxaddress=${LNC_MAILBOX:-mailbox.terminal.lightning.today:443}
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - satgate-internal
      - satgate-external
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ---------------------------------------------------------------------------
  # Docs & Playground Server
  # ---------------------------------------------------------------------------
  docs:
    image: nginx:alpine
    container_name: satgate-docs
    restart: unless-stopped
    ports:
      - "${DOCS_PORT:-8080}:80"
    volumes:
      - ./docs:/usr/share/nginx/html/docs:ro
      - ./sdk:/usr/share/nginx/html/sdk:ro
      - ./nginx/docs.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - aperture
    networks:
      - satgate-external
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

networks:
  satgate-internal:
    driver: bridge
    internal: true
  satgate-external:
    driver: bridge

volumes:
  aperture-data:

