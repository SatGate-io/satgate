# =============================================================================
# SatGate Gateway Mode: Envoy External Authorization Configuration
# =============================================================================
#
# This configuration uses Envoy's ext_authz HTTP filter to integrate with
# SatGate's Auth Decision API.
#
# Key features:
#   - HTTP-based ext_authz (not gRPC) for simplicity
#   - Proper header forwarding for L402 challenges
#   - Fail-closed behavior
#   - Configurable timeouts
#
# How it works:
#   1. Request arrives at Envoy
#   2. ext_authz calls SatGate /auth/decide with request metadata
#   3. If 200: continue to upstream
#   4. If 402/403/429: return that response directly to client
#   5. If timeout/error: fail closed (503)
#

static_resources:
  listeners:
    - name: main_listener
      address:
        socket_address:
          address: 0.0.0.0
          port_value: 8080
      filter_chains:
        - filters:
            - name: envoy.filters.network.http_connection_manager
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                stat_prefix: ingress_http
                codec_type: AUTO
                
                # Generate request IDs
                request_id_extension:
                  typed_config:
                    "@type": type.googleapis.com/envoy.extensions.request_id.uuid.v3.UuidRequestIdConfig
                    pack_trace_reason: true
                
                route_config:
                  name: local_route
                  virtual_hosts:
                    - name: api_service
                      domains: ["*"]
                      routes:
                        # Protected API routes
                        - match:
                            prefix: "/v1/"
                          route:
                            cluster: backend_cluster
                            timeout: 30s
                        
                        # Health check (no auth)
                        - match:
                            path: "/health"
                          route:
                            cluster: backend_cluster
                          # Skip ext_authz for health checks
                          typed_per_filter_config:
                            envoy.filters.http.ext_authz:
                              "@type": type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthzPerRoute
                              disabled: true
                
                http_filters:
                  # External Authorization (SatGate)
                  - name: envoy.filters.http.ext_authz
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthz
                      
                      # Use HTTP service (not gRPC)
                      http_service:
                        server_uri:
                          uri: satgate_auth:9090
                          cluster: satgate_auth_cluster
                          timeout: 5s
                        
                        # Auth request path
                        path_prefix: "/auth/decide"
                        
                        # Headers to send to auth service
                        authorization_request:
                          allowed_headers:
                            patterns:
                              - exact: "authorization"
                              - exact: "content-type"
                          headers_to_add:
                            # Add original request metadata
                            - key: "X-Original-Method"
                              value: "%REQ(:METHOD)%"
                            - key: "X-Original-URI"
                              value: "%REQ(:PATH)%"
                            - key: "X-Original-Host"
                              value: "%REQ(:AUTHORITY)%"
                            - key: "X-Original-Proto"
                              value: "%REQ(:SCHEME)%"
                            - key: "X-Forwarded-For"
                              value: "%DOWNSTREAM_REMOTE_ADDRESS_WITHOUT_PORT%"
                            - key: "X-Request-Id"
                              value: "%REQ(X-REQUEST-ID)%"
                        
                        # Headers to propagate from auth response to client on deny
                        authorization_response:
                          # Headers to add to downstream response on 4xx
                          allowed_client_headers:
                            patterns:
                              - exact: "www-authenticate"
                              - exact: "x-l402-price"
                              - exact: "x-l402-tier"
                              - exact: "x-l402-ttl"
                              - exact: "x-l402-max-calls"
                              - exact: "x-request-id"
                              - exact: "x-satgate-route"
                              - exact: "x-satgate-tier"
                              - exact: "x-calls-remaining"
                              - exact: "x-budget-remaining"
                              - exact: "content-type"
                              - exact: "cache-control"
                              - exact: "pragma"
                          
                          # Headers to add to upstream request on allow
                          allowed_upstream_headers:
                            patterns:
                              - exact: "x-satgate-route"
                              - exact: "x-satgate-tier"
                              - exact: "x-satgate-scope"
                              - exact: "x-calls-remaining"
                              - exact: "x-budget-remaining"
                              - exact: "x-request-id"
                      
                      # Fail-closed behavior
                      failure_mode_allow: false
                      
                      # Include request body in auth (disabled for performance)
                      with_request_body:
                        max_request_bytes: 0
                        allow_partial_message: true
                      
                      # Status codes to pass through
                      status_on_error:
                        code: ServiceUnavailable
                      
                      # Clear route cache after auth (allows header-based routing)
                      clear_route_cache: true
                  
                  # Router (must be last)
                  - name: envoy.filters.http.router
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

  clusters:
    # Your protected backend
    - name: backend_cluster
      type: STRICT_DNS
      lb_policy: ROUND_ROBIN
      load_assignment:
        cluster_name: backend_cluster
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: 10.0.2.10
                      port_value: 8080
      health_checks:
        - timeout: 5s
          interval: 10s
          unhealthy_threshold: 3
          healthy_threshold: 1
          http_health_check:
            path: "/health"

    # SatGate auth service (admin plane)
    - name: satgate_auth_cluster
      type: STRICT_DNS
      lb_policy: ROUND_ROBIN
      connect_timeout: 1s
      load_assignment:
        cluster_name: satgate_auth_cluster
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: 127.0.0.1
                      port_value: 9090
      health_checks:
        - timeout: 1s
          interval: 5s
          unhealthy_threshold: 3
          healthy_threshold: 1
          http_health_check:
            path: "/auth/health"

# Admin interface for debugging
admin:
  address:
    socket_address:
      address: 127.0.0.1
      port_value: 9901

